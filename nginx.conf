# Конфигурация Nginx для проксирования запросов между фронтендом и бэкендом

# Определение upstream серверов для балансировки нагрузки
upstream backend {
  # Backend сервер на порту 5000 (Node.js/Express)
  server backend:5000;
}

upstream frontend {
  # Frontend сервер на порту 3000 (Next.js)
  server frontend:3000;
}

server {
  # Слушаем на 80 порту (HTTP)
  listen 80;
  # Доменное имя сервера
  server_name farylve.online _;
  # Максимальный размер тела запроса (для загрузки файлов)
  client_max_body_size 10m;

  # Эндпоинт для проверки здоровья приложения
  location /healthz {
    proxy_pass http://backend/health;
    proxy_http_version 1.1;
    # Передача оригинальных заголовков
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Таймауты для стабильной работы
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Все API запросы направляем на backend
  location /api/ {
    proxy_pass http://backend/api/;
    proxy_http_version 1.1;
    # Передача оригинальных заголовков клиента
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Настройки таймаутов
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Корневой путь - направляем на фронтенд (Next.js)
  location = / {
    proxy_pass http://frontend;
    proxy_http_version 1.1;
    # Сохранение оригинальных заголовков
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Таймауты соединения
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Корневой API эндпоинт для JSON запросов
  location = /api {
    proxy_pass http://backend;
    proxy_http_version 1.1;
    # Передача заголовков для корректной работы API
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Настройки таймаутов
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
  }

  # Все остальные запросы направляем на фронтенд
  location / {
    proxy_pass http://frontend;
    proxy_http_version 1.1;
    # Передача всех необходимых заголовков
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Таймауты для стабильной работы
    proxy_connect_timeout 60s;
    proxy_read_timeout 60s;
  }
}